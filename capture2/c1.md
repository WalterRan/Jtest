
# Table of Contents

1.  [Title](#orgd2dfffa)
    1.  [Title](#org58f07d0)
    2.  [upcall](#orgefbc4a3)
2.  [env](#org1a37458)
    1.  [VSC](#org645b16d)
    2.  [OVS](#org715036e)
    3.  [VRS](#org5b1f97e)
    4.  [start new](#orgd7bfa18)
    5.  [从sdn5发送的arp](#org9ae4605)
3.  [ovs-db](#org09dc03b)
    1.  [commands](#org6c13f05)
        1.  [ovsdb-client list-dbs](#org55cd403)
        2.  [ovsdb-client list-tables Open<sub>vSwitch</sub>](#orgb2a3d78)
        3.  [ovsdb-client dump Open<sub>vSwitch</sub> Nuage<sub>Route</sub>](#org221139a)
        4.  [ovsdb-client dump Open<sub>vSwitch</sub> Nuage<sub>VM</sub><sub>Table</sub>](#orgc2655c7)
4.  [file-diff](#org852bfc8)
    1.  [[root@sdn5 ~]# nu-ping &#x2013;help](#org51368e8)
    2.  [ovs支持ofv1 and v4](#org2b36321)
    3.  [startup](#org78043f4)
        1.  [valgrind](#orgc59d29c)
        2.  [aarch64 vm](#orge2ddef1)
5.  [links](#org16122fa)
    1.  [openvswitch实现arp代答和icmp代答](#org67a8a0c)
6.  [qemu-aarch64](#orgaffcf15)
    1.  [create fs](#org4c8d996)
    2.  [start from img](#org15b7a55)
    3.  [install from iso](#orga68b269)
    4.  [step by step](#org4937e69)
        1.  [disk scale](#org06638f2)
        2.  [start vm (nested vm)](#org3437a6f)
        3.  [compile ovs](#org651a7fb)
        4.  [raspberry compile time](#org662b3b5)
        5.  [raspberry start vm](#org31b25d4)
        6.  [eth0](#org47ac604)
        7.  [wifi config](#org012cc45)
        8.  [packstack](#orgf7cc56f)
        9.  [nova](#org774799c)
        10. [arm-wifi](#org9d38803)
        11. [](#org2d5fda5)
        12. [man ovn-northd](#orgc39254e)
        13. [temp](#orgd1de4e0)


<a id="orgd2dfffa"></a>

# Title


<a id="org58f07d0"></a>

## Title

module<sub>init</sub>(dp<sub>init</sub>);

dp<sub>register</sub><sub>genl</sub>(); // register dp<sub>genl</sub><sub>families</sub>

include:
 &dp<sub>datapath</sub><sub>genl</sub><sub>family</sub>,
 &dp<sub>vport</sub><sub>genl</sub><sub>family</sub>,
 &dp<sub>flow</sub><sub>genl</sub><sub>family</sub>, // recieve flow tables from userspace
 &dp<sub>packet</sub><sub>genl</sub><sub>family</sub>,
 &dp<sub>meter</sub><sub>genl</sub><sub>family</sub>,


<a id="orgefbc4a3"></a>

## upcall

upcall<sub>xlate</sub>
do<sub>xlate</sub><sub>actions</sub>


<a id="org1a37458"></a>

# env


<a id="org645b16d"></a>

## VSC

11.251.96.44


<a id="org715036e"></a>

## OVS

11.251.96.22


<a id="org5b1f97e"></a>

## VRS

11.251.96.4
aee6fc50-8c35-4975-a9fd-533009ce8d1a
instance-00003905

11.251.96.5
8b86bb96-71a9-41a9-8a6d-60aac6104c2a
instance-00003908


<a id="orgd7bfa18"></a>

## start new

nova boot &#x2013;image centos<sub>v6</sub>  &#x2013;flavor m1.small &#x2013;nic net-id=7e6f02be-5958-4e87-9117-0cb0bd31115f weihuap-vm158-1


<a id="org9ae4605"></a>

## 从sdn5发送的arp

watch -n 1 "ovs-ofctl -O OpenFlow13 packet-out alubr0 8 normal fffffffffffffa163e3aff300806000108000604000


<a id="org09dc03b"></a>

# ovs-db


<a id="org6c13f05"></a>

## commands


<a id="org55cd403"></a>

### ovsdb-client list-dbs


<a id="orgb2a3d78"></a>

### ovsdb-client list-tables Open<sub>vSwitch</sub>


<a id="org221139a"></a>

### ovsdb-client dump Open<sub>vSwitch</sub> Nuage<sub>Route</sub>


<a id="orgc2655c7"></a>

### ovsdb-client dump Open<sub>vSwitch</sub> Nuage<sub>VM</sub><sub>Table</sub>


<a id="org852bfc8"></a>

# file-diff


<a id="org51368e8"></a>

## [root@sdn5 ~]# nu-ping &#x2013;help

usage: nu-ping [-h] -ed ETH<sub>DST</sub> -id IP<sub>DST</sub> -vp VPORT [-v]

Nuage Ping

optional arguments:
-h, &#x2013;help            show this help message and exit
-ed ETH<sub>DST</sub>, &#x2013;eth<sub>dst</sub> ETH<sub>DST</sub>
ethernet destination address
-id IP<sub>DST</sub>, &#x2013;ip<sub>dst</sub> IP<sub>DST</sub>
ip destination address
-vp VPORT, &#x2013;vport VPORT
local vport
-v, &#x2013;verbose         verbose


<a id="org2b36321"></a>

## ovs支持ofv1 and v4

[root@sdn5 home]# ovs-ofctl -V
ovs-ofctl (Open vSwitch) 6.0.10-381-nuage
Compiled Oct  3 2020 00:28:32
Open vSwitch base release: 0x250
OpenFlow versions 0x1:0x4

startup时同时发起v1和v4，但是vsc没有回应v4，vsc应该是不支持v4的，没找到证据


<a id="org78043f4"></a>

## startup

/usr/share/openvswitch/scripts/openvswitch.init start

/usr/share/openvswitch/scripts/ovs-ctl
start &#x2013;system-id=random &#x2013;default-bridge=alubr0 &#x2013;bridge-mtu=1600 &#x2013;conn-type=tcp
&#x2013;active-controller=11.251.96.44 &#x2013;personality=vrs &#x2013;skb-lro-mod-enabled=no
&#x2013;gw-hb-timeout=2000 &#x2013;gw-role=backup &#x2013;network-uplink-intf=eth0 &#x2013;enable-network-uplink-proxy-arp=true
&#x2013;network-namespace=pat &#x2013;revertive-controller=no &#x2013;revertive-timer=300 &#x2013;k8s-service-ipv4-subnet=0.0.0.0/8
&#x2013;k8s-pod-network-cidr=0.0.0.0/8 &#x2013;agg-flow-mode=yes &#x2013;vport-flow-limit=0 &#x2013;vport-flow-limit-drop-timeout=1


<a id="orgc59d29c"></a>

### valgrind

内存泄漏检测工具


<a id="orge2ddef1"></a>

### aarch64 vm

    virt-install \
    --virt-type=kvm \
    --name centos-aarch64 \
    --ram 8192 \
    --vcpus=4 \
    --os-variant=centos7.0 \
    --cdrom=/home/jing/CentOS-7-aarch64-Minimal-2009.iso \
    --network=bridge=br135,model=virtio \
    --graphics vnc \
    --disk path=/home/jing/centos-aarch64.qcow2,size=80,bus=virtio,format=qcow2


<a id="org16122fa"></a>

# links


<a id="org67a8a0c"></a>

## openvswitch实现arp代答和icmp代答

<https://blog.csdn.net/yuyin1018/article/details/106720530>


<a id="orgaffcf15"></a>

# qemu-aarch64


<a id="org4c8d996"></a>

## create fs

"C:/Program Files/qemu/qemu-img" create -f qcow2 centos-aarch64.qcow2 128G


<a id="org15b7a55"></a>

## start from img

"C:/Program Files/qemu/qemu-img" info CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw

"C:/Program Files/qemu/qemu-img" resize CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw 128G

    "C:/Program Files/qemu/qemu-system-aarch64" \
    -cpu cortex-a72 -smp 4 -M virt -m 8192 \
    -hda CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw \
    -drive if=pflash,format=raw,file=QEMU_EFI.img \
    -netdev user,id=n1 -device virtio-net-pci,netdev=n1 \
    -vga std \
    -serial telnet::5555,server,nowait

    "C:/Program Files/qemu/qemu-system-aarch64" \
    -cpu cortex-a72 -smp 4 -M virt -m 8192 \
    -drive file=CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw,format=raw,index=0,media=disk \
    -drive if=pflash,format=raw,file=QEMU_EFI.img \
    -netdev user,id=n1 -device virtio-net-pci,netdev=n1 \
    -vga std \
    -serial telnet::5555,server,nowait


<a id="orga68b269"></a>

## install from iso

    "C:/Program Files/qemu/qemu-system-aarch64" \
    -cpu cortex-a72 -smp 4 -M virt -m 8192 \
    -hda centos-aarch64.qcow2 \
    -drive if=pflash,format=raw,file=QEMU_EFI.img \
    -drive if=virtio,format=raw,file=CentOS-7-aarch64-Minimal-2009.iso \
    -vga std \
    -serial telnet::5555,server,nowait


<a id="org4937e69"></a>

## step by step


<a id="org06638f2"></a>

### disk scale

fdisk /dev/vda4

resize2fs /dev/vda4


<a id="org3437a6f"></a>

### start vm (nested vm)

yum -y install libguestfs-tools libguestfs-xfs virt-top

virt-builder centos-7.2 &#x2013;format qcow2 -o centos72.qcow2 &#x2013;root-password password

    virt-install \
    --name centos-72 \
    --ram 2048 \
    --disk path=/home/centos-7.8.qcow2 \
    --vcpus 2 \
    --os-type linux \
    --os-variant rhel7.2 \
    --network bridge=br0 \
    --graphics none \
    --serial pty \
    --console pty \
    --boot hd \
    --import

    virt-install \ 
    --name vvm \ 
    --memory 2048 \ 
    --vcpus 2 \ 
    --disk size=8 \ 
    --cdrom /home/CentOS-7-aarch64-Minimal-2009.iso \
    --os-variant rhel7

    virt-install --name=vvm-raw \
    --disk path=/home/CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw,sparse=true,cache=none,bus=virtio,format=raw \
    --vcpus=2 \
    --ram=2048 \
    --network bridge=br0,model=virtio \
    --boot hd \
    --os-type=linux

virsh undefine &#x2013;nvram vvm


<a id="org651a7fb"></a>

### compile ovs

yum install make gcc curl wget vim openssl-devel autoconf automake rpm-build libtool redhat-rpm-config python-devel openssl-devel kernel-devel kernel-debug-devel


<a id="org662b3b5"></a>

### raspberry compile time

real    9m46.301s
user    7m51.526s
sys     0m38.228s


<a id="org31b25d4"></a>

### raspberry start vm

    virt-install --name=vvm-raw \
    --disk path=/home/CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw,sparse=true,cache=none,bus=virtio,format=raw \
    --vcpus=2 \
    --ram=2048 \
    --network bridge=br0,model=virtio \
    --boot hd \
    --os-type=linux


<a id="org47ac604"></a>

### eth0

[root@localhost home]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE=Ethernet
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
NAME=eth0
DEVICE=eth0
ONBOOT=yes
IPADDR=192.168.0.66
NETMASK=255.255.255.0
GATEWAY=192.168.0.1


<a id="org012cc45"></a>

### wifi config

nmtui


<a id="orgf7cc56f"></a>

### packstack

yum install vim tmux -y

systemctl disable firewalld
systemctl stop firewalld
systemctl disable NetworkManager
systemctl stop NetworkManager
systemctl enable network
systemctl start network
setenforce 0
vim /etc/selinux/config

yum update -y

yum install -y <https://rdoproject.org/repos/rdo-release.rpm>

yum install -y openstack-packstack

packstack &#x2013;allinone

packstack &#x2013;gen-answer-file=answers.txt \\
&#x2013;provision-demo=n \\
&#x2013;os-neutron-ovn-bridge-mappings=extnet:br-ex \\
&#x2013;os-neutron-ovn-bridge-interfaces=br-ex:enp0s3 \\
&#x2013;os-debug-mode=y \\
&#x2013;os-cinder-install=n \\
&#x2013;os-swift-install=n \\
&#x2013;os-ceilometer-install=n \\
&#x2013;os-aodh-install=n \\
&#x2013;cinder-volumes-create=n \\
&#x2013;os-heat-cfn-install=n \\
&#x2013;os-neutron-ovn-tunnel-if=enp0s8 \\
&#x2013;os-neutron-ovn-tunnel-subnets=192.168.56.0/24 \\
&#x2013;os-compute-hosts=192.168.56.107,192.168.56.108

packstack &#x2013;answer-file=answers.txt


<a id="org774799c"></a>

### nova

應該改 nova.conf
將 [libvirt] 內的
cpu<sub>mode</sub> 改成 host-passthrough


<a id="org9d38803"></a>

### arm-wifi

arm-wifi / 1234512345
admin / asb!234
<https://192.168.137.220:8443/>


<a id="org2d5fda5"></a>

### 

openstack image create "cirros" &#x2013;file /home/cirros-0.5.1-aarch64-disk.img &#x2013;disk-format qcow2 &#x2013;public

nova boot &#x2013;image cirros &#x2013;flavor m1.tiny &#x2013;nic net-name=jing-net jing-vm1

neutron net-create ext-net &#x2013;shared &#x2013;router:external=True

neutron subnet-create ext-net &#x2013;name ext-subnet &#x2013;allocation-pool start=10.0.2.20,end=10.0.2.50 &#x2013;enable-dhcp &#x2013;gateway 10.0.2.2 10.0.2.0/24

neutron router-gateway-set jing-router ext-net


<a id="orgc39254e"></a>

### man ovn-northd

ovn-northd
ovn-controller

ovs-vsctl set open . external-ids:ovn-encap-ip=10.0.0.10


<a id="orgd1de4e0"></a>

### temp

virt-install &#x2013;name vvm &#x2013;memory 2048 &#x2013;vcpus 2 &#x2013;disk size=8 &#x2013;cdrom /home/CentOS-7-aarch64-Minimal-2009.iso &#x2013;os-variant rhel7

virt-install &#x2013;name=vvm-raw &#x2013;disk path=/home/CentOS-Userland-7-aarch64-generic-Minimal-2009-sda.raw,sparse=true,cache=none,bus=virtio,format=raw &#x2013;vcpus=2 &#x2013;ram=2048 &#x2013;network bridge=br0,model=virtio &#x2013;boot hd &#x2013;os-type=linux


